<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0B0F1A">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“Š</text></svg>">
  <title>Daily Collection Report</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#0B0F1A; --surface:#131825; --border:rgba(255,255,255,0.06);
      --text:#E8ECF4; --muted:#6B7A99; --accent:#4F8CFF;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
    body::before{content:'';position:fixed;top:-200px;left:50%;transform:translateX(-50%);width:800px;height:600px;background:radial-gradient(ellipse,rgba(79,140,255,0.08) 0%,transparent 70%);pointer-events:none;}

    .login-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;}
    .login-box{width:100%;max-width:420px;position:relative;z-index:1;}

    .brand{text-align:center;margin-bottom:36px;}
    .brand h1{font-family:'Playfair Display',serif;font-size:28px;letter-spacing:-0.5px;}
    .brand p{font-size:13px;color:var(--muted);margin-top:4px;}

    /* Search */
    .search-box{position:relative;margin-bottom:8px;}
    .search-box svg{position:absolute;left:16px;top:50%;transform:translateY(-50%);width:18px;height:18px;color:var(--muted);pointer-events:none;}
    .search-input{
      width:100%;padding:16px 16px 16px 46px;border:1px solid var(--border);
      border-radius:14px;background:var(--surface);color:var(--text);font-size:16px;
      font-family:inherit;outline:none;transition:all 0.2s;
    }
    .search-input::placeholder{color:#3d4a63;}
    .search-input:focus{border-color:rgba(79,140,255,0.4);box-shadow:0 0 0 4px rgba(79,140,255,0.08);}

    /* Results */
    .results{
      border-radius:14px;overflow:hidden;
      border:1px solid var(--border);background:var(--surface);
      max-height:350px;overflow-y:auto;
      transition:all 0.2s;
    }
    .results:empty{border:none;}
    .results::-webkit-scrollbar{width:3px;}
    .results::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px;}

    .emp-row{
      display:flex;align-items:center;gap:14px;padding:14px 18px;
      cursor:pointer;transition:background 0.15s;
      border-bottom:1px solid rgba(255,255,255,0.03);
    }
    .emp-row:last-child{border-bottom:none;}
    .emp-row:hover,.emp-row:focus{background:rgba(79,140,255,0.08);outline:none;}
    .emp-row:active{background:rgba(79,140,255,0.14);}

    .avatar{
      width:40px;height:40px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      font-weight:700;font-size:15px;flex-shrink:0;
    }
    .avatar-emp{background:rgba(52,211,153,0.12);color:#34D399;}
    .avatar-admin{background:rgba(251,191,36,0.12);color:#FBBF24;}
    .avatar-ceo{background:rgba(251,191,36,0.12);color:#FBBF24;}
    .avatar-rm{background:rgba(139,92,246,0.12);color:#A78BFA;}
    .avatar-dm{background:rgba(59,130,246,0.12);color:#60A5FA;}
    .avatar-bm{background:rgba(16,185,129,0.12);color:#34D399;}

    .emp-detail{flex:1;min-width:0;}
    .emp-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .emp-id{font-size:11px;color:var(--muted);margin-top:1px;}

    .row-arrow{color:#3d4a63;font-size:20px;flex-shrink:0;transition:transform 0.2s;}
    .emp-row:hover .row-arrow{transform:translateX(2px);color:var(--accent);}

    /* Highlight matched text */
    mark{background:none;color:var(--accent);font-weight:700;}

    /* Status */
    .status{text-align:center;padding:24px 16px;color:var(--muted);font-size:13px;}
    .status-icon{font-size:32px;margin-bottom:8px;display:block;}

    /* Hint */
    .hint{text-align:center;color:#3d4a63;font-size:11px;margin-top:12px;letter-spacing:0.3px;}

    /* Spinner */
    .spinner{width:28px;height:28px;border:3px solid rgba(79,140,255,0.15);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 10px;}
    @keyframes spin{to{transform:rotate(360deg);}}
  </style>
</head>
<body>
  <div class="login-wrap">
    <div class="login-box">
      <div class="brand">
        <h1>Collection Report</h1>
        <p>Empowering Employees</p>
      </div>

      <div class="search-box">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input class="search-input" id="search" type="text" placeholder="Type your name or ID..." autocomplete="off" autofocus>
      </div>

      <div class="results" id="results"></div>
      <div class="status" id="status"><div class="spinner"></div>Loading employees...</div>
      <div class="hint" id="hint"></div>
    </div>
  </div>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <script src="js/employeeParser.js?v=9"></script>
  <script src="js/storage.js?v=9"></script>
  <script src="js/auth.js?v=9"></script>
  <script>
  (function () {
    if (typeof isAdminAuthenticated === 'function' && isAdminAuthenticated()) {
      window.location.href = 'admin.html'; return;
    }
    if (typeof isEmployeeAuthenticated === 'function' && isEmployeeAuthenticated()) {
      window.location.href = 'employee.html'; return;
    }

    var allEmployees = [];
    var search = document.getElementById('search');
    var results = document.getElementById('results');
    var status = document.getElementById('status');
    var hint = document.getElementById('hint');

    // Cached location data for role-based login
    var _locationData = null;
    var _locationLoading = false;

    function _parseLocationData() {
      if (_locationData) return Promise.resolve(_locationData);
      if (_locationLoading) {
        return new Promise(function (resolve) {
          var check = setInterval(function () {
            if (_locationData) { clearInterval(check); resolve(_locationData); }
          }, 100);
        });
      }
      _locationLoading = true;
      return initDB().then(function () { return getWorkbookWithFallback(); })
        .then(function (wb) {
          if (!wb || !wb.data) return { regions: [], districts: [], branches: [] };
          var workbook = XLSX.read(new Uint8Array(wb.data), { type: 'array', cellFormula: false, cellNF: true });
          var targetSheet = null;
          for (var s = 0; s < workbook.SheetNames.length; s++) {
            if (workbook.SheetNames[s].toUpperCase().includes('OVERALL')) {
              targetSheet = workbook.Sheets[workbook.SheetNames[s]]; break;
            }
          }
          if (!targetSheet) {
            for (var s = 0; s < workbook.SheetNames.length; s++) {
              var ws = workbook.Sheets[workbook.SheetNames[s]];
              if (ws && ws['!ref']) {
                var dec = XLSX.utils.decode_range(ws['!ref']);
                if (dec.e.c >= 15) { targetSheet = ws; break; }
              }
            }
          }
          if (!targetSheet) return { regions: [], districts: [], branches: [] };

          var rows = XLSX.utils.sheet_to_json(targetSheet, { header: 1 });
          var regions = [], districts = [], branches = [];
          var currentSection = null;

          for (var r = 0; r < rows.length; r++) {
            var row = rows[r];
            if (!row || !row.length) continue;
            var firstCell = String(row[0] || '').trim().toUpperCase();
            var secondCell = String(row[1] || '').trim().toUpperCase();

            // Detect section headers (text may be in col 0 or col 1)
            var headerText = firstCell + ' ' + secondCell;
            if (headerText.includes('REGION') && (headerText.includes('WISE') || headerText.includes('NAME'))) {
              currentSection = 'region'; continue;
            }
            if (headerText.includes('DISTRICT') && (headerText.includes('WISE') || headerText.includes('NAME'))) {
              currentSection = 'district'; continue;
            }
            if (headerText.includes('BRANCH') && !headerText.includes('OFFICER') && (headerText.includes('WISE') || headerText.includes('NAME'))) {
              currentSection = 'branch'; continue;
            }
            // Header rows with SL/NAME/DEMAND â€” skip
            if (firstCell === 'SL' || firstCell === 'SL.' || firstCell === 'SL NO' || firstCell === 'S.NO' || firstCell === 'SR') continue;
            if (secondCell === 'SL' || secondCell === 'SL.' || secondCell === 'OFFICER NAME' || secondCell === 'NAME') continue;

            // Grand Total ends a section
            if (firstCell.includes('GRAND TOTAL') || secondCell.includes('GRAND TOTAL') || firstCell === 'GRAND TOTAL' || secondCell === 'GRAND TOTAL') {
              currentSection = null; continue;
            }
            // "Total" rows â€” skip
            if (/^TOTAL/i.test(firstCell)) continue;

            // Collect names from column 1 (name column)
            var name = String(row[1] || '').trim();
            if (!name || /^\d+$/.test(name)) {
              name = String(row[0] || '').trim();
            }
            if (!name || /^\d+$/.test(name)) continue;
            // Skip if it looks like a header keyword
            if (/^(SL|NAME|OFFICER|DEMAND|COLLECTION|REG|DISTRICT|BRANCH)/i.test(name)) continue;

            if (currentSection === 'region') regions.push(name);
            else if (currentSection === 'district') districts.push(name);
            else if (currentSection === 'branch') branches.push(name);
          }

          _locationData = { regions: regions, districts: districts, branches: branches };
          _locationLoading = false;
          return _locationData;
        })
        .catch(function (err) {
          console.error('Location parse error:', err);
          _locationLoading = false;
          return { regions: [], districts: [], branches: [] };
        });
    }

    // Load employees
    initDB().then(function () { return getAllEmployeesWithFallback(); })
    .then(function (emps) {
      if (!emps || !emps.length) {
        status.innerHTML = '<span class="status-icon">&#128203;</span>No employees found.<br>Admin must upload a report first.';
        return;
      }
      emps.sort(function (a, b) { return a.name.localeCompare(b.name); });
      allEmployees = emps;
      status.textContent = emps.length + ' employees loaded';
      hint.textContent = 'Start typing to find yourself';
      search.focus();
    })
    .catch(function (err) {
      console.error('Employee load error:', err);
      status.innerHTML = '<span class="status-icon">&#9888;</span>Failed to load employees.<br><small style="color:#4a5568">Pull to refresh or check connection.</small>';
    });

    function esc(s) { return s.replace(/[&<>"']/g, function (c) { return '&#' + c.charCodeAt(0) + ';'; }); }

    function highlight(text, q) {
      if (!q) return esc(text);
      var idx = text.toUpperCase().indexOf(q.toUpperCase());
      if (idx === -1) return esc(text);
      return esc(text.slice(0, idx)) + '<mark>' + esc(text.slice(idx, idx + q.length)) + '</mark>' + esc(text.slice(idx + q.length));
    }

    // Render role rows (CEO/RM/DM/BM)
    function renderRoleRow(role, name, subtitle, filterQ) {
      var avatarClass = 'avatar-' + role.toLowerCase();
      var icon = role === 'CEO' ? '&#9733;' : role.charAt(0);
      var displayName = filterQ ? highlight(name, filterQ) : esc(name);
      return '<div class="emp-row" data-role="' + esc(role) + '" data-location="' + esc(name) + '" tabindex="0">' +
        '<div class="avatar ' + avatarClass + '">' + icon + '</div>' +
        '<div class="emp-detail">' +
          '<div class="emp-name">' + displayName + '</div>' +
          '<div class="emp-id">' + esc(subtitle) + '</div>' +
        '</div>' +
        '<div class="row-arrow">&#8250;</div>' +
      '</div>';
    }

    var _roleSearchPending = false;

    search.addEventListener('input', function () {
      var q = this.value.trim();
      if (q.length < 1) {
        results.innerHTML = '';
        status.style.display = '';
        hint.style.display = '';
        return;
      }
      status.style.display = 'none';
      hint.style.display = 'none';

      var qu = q.toUpperCase();

      // --- CEO keyword ---
      if (qu === 'CEO') {
        results.innerHTML = renderRoleRow('CEO', 'Overall', 'CEO \u2014 Overall View', '');
        return;
      }

      // --- RM / DM / BM keywords ---
      var roleMatch = qu.match(/^(RM|DM|BM)\s*(.*)/);
      if (roleMatch) {
        var role = roleMatch[1];
        var filter = roleMatch[2].trim();
        results.innerHTML = '<div class="status"><div class="spinner"></div>Loading locations...</div>';
        _roleSearchPending = true;
        _parseLocationData().then(function (data) {
          if (!_roleSearchPending) return;
          var list;
          var subtitle;
          if (role === 'RM') { list = data.regions; subtitle = 'Regional Manager'; }
          else if (role === 'DM') { list = data.districts; subtitle = 'District Manager'; }
          else { list = data.branches; subtitle = 'Branch Manager'; }

          if (filter) {
            list = list.filter(function (n) { return n.toUpperCase().includes(filter); });
          }

          if (!list.length) {
            results.innerHTML = '<div class="status">No locations found</div>';
            return;
          }

          results.innerHTML = list.map(function (name) {
            return renderRoleRow(role, name, subtitle + ' \u2014 ' + name, filter);
          }).join('');
        });
        return;
      }

      // Cancel any pending role search
      _roleSearchPending = false;

      // --- Admin keyword ---
      var isAdmin = qu === 'ADMIN';

      var matches = [];
      if (isAdmin) {
        matches.push({ id: '__admin__', name: 'Admin Panel', isAdmin: true });
      }

      var emps = allEmployees.filter(function (e) {
        return e.name.toUpperCase().includes(qu) || String(e.id).toUpperCase().includes(qu);
      }).slice(0, 25);

      matches = matches.concat(emps);

      if (!matches.length) {
        results.innerHTML = '<div class="status">No matches found</div>';
        return;
      }

      results.innerHTML = matches.map(function (e) {
        if (e.isAdmin) {
          return '<div class="emp-row" data-admin="1" tabindex="0">' +
            '<div class="avatar avatar-admin">&#9881;</div>' +
            '<div class="emp-detail">' +
              '<div class="emp-name">Admin Panel</div>' +
              '<div class="emp-id">Manage reports & employees</div>' +
            '</div>' +
            '<div class="row-arrow">&#8250;</div>' +
          '</div>';
        }
        var initial = e.name.charAt(0).toUpperCase();
        return '<div class="emp-row" data-id="' + esc(String(e.id)) + '" tabindex="0">' +
          '<div class="avatar avatar-emp">' + initial + '</div>' +
          '<div class="emp-detail">' +
            '<div class="emp-name">' + highlight(e.name, q) + '</div>' +
            '<div class="emp-id">ID: ' + highlight(String(e.id), q) + '</div>' +
          '</div>' +
          '<div class="row-arrow">&#8250;</div>' +
        '</div>';
      }).join('');
    });

    // Keyboard nav
    search.addEventListener('keydown', function (e) {
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        var first = results.querySelector('.emp-row');
        if (first) first.focus();
      }
    });

    results.addEventListener('keydown', function (e) {
      var row = e.target.closest('.emp-row');
      if (!row) return;
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        var next = row.nextElementSibling;
        if (next && next.classList.contains('emp-row')) next.focus();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        var prev = row.previousElementSibling;
        if (prev && prev.classList.contains('emp-row')) prev.focus();
        else search.focus();
      } else if (e.key === 'Enter') {
        row.click();
      }
    });

    // Click to login
    results.addEventListener('click', function (ev) {
      var row = ev.target.closest('.emp-row');
      if (!row) return;

      // Admin
      if (row.dataset.admin === '1') {
        var pass = prompt('Enter admin passcode:');
        if (pass) {
          authenticateAdmin(pass).then(function (ok) {
            if (ok) window.location.href = 'admin.html';
            else alert('Incorrect passcode.');
          });
        }
        return;
      }

      // Role-based login (CEO/RM/DM/BM)
      if (row.dataset.role) {
        row.style.background = 'rgba(79,140,255,0.14)';
        row.style.pointerEvents = 'none';
        clearRoleNavStack();
        setRoleSession(row.dataset.role, row.dataset.location);
        window.location.href = 'employee.html';
        return;
      }

      // Employee
      row.style.background = 'rgba(79,140,255,0.14)';
      row.style.pointerEvents = 'none';
      clearRoleNavStack();
      authenticateEmployee(row.dataset.id).then(function (ok) {
        if (ok) window.location.href = 'employee.html';
        else { row.style.background = ''; row.style.pointerEvents = ''; }
      }).catch(function () { row.style.background = ''; row.style.pointerEvents = ''; });
    });
  })();
  </script>
  <script>if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js');}</script>
</body>
</html>

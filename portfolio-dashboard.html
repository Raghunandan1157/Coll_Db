<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0B0F1A;
    --surface: #131825;
    --surface-2: #1A2035;
    --border: rgba(255,255,255,0.06);
    --text: #E8ECF4;
    --text-muted: #6B7A99;
    --accent: #4F8CFF;
    --accent-glow: rgba(79,140,255,0.15);
    --green: #34D399;
    --amber: #FBBF24;
    --orange: #FB923C;
    --red: #F87171;
    --crimson: #DC2626;
    --radius: 16px;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }
  body::before {
    content: '';
    position: fixed;
    top: -200px; left: 50%;
    transform: translateX(-50%);
    width: 800px; height: 600px;
    background: radial-gradient(ellipse, rgba(79,140,255,0.08) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }
  .app {
    max-width: 480px;
    margin: 0 auto;
    padding: 20px 16px 100px;
    position: relative;
    z-index: 1;
  }

  /* Header */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .header-left h1 {
    font-family: 'Playfair Display', serif;
    font-size: 24px;
    font-weight: 700;
    letter-spacing: -0.5px;
  }
  .header-left .subtitle {
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 2px;
  }

  /* Date Badge - Clickable */
  .date-badge {
    background: var(--surface-2);
    border: 1px solid var(--border);
    padding: 8px 14px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 500;
    color: var(--accent);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    user-select: none;
  }
  .date-badge:hover {
    background: rgba(79,140,255,0.1);
    border-color: rgba(79,140,255,0.25);
  }
  .date-badge svg {
    width: 14px; height: 14px;
  }

  /* Bottom Tab Bar */
  .tab-bar {
    position: fixed;
    bottom: 0; left: 50%;
    transform: translateX(-50%);
    max-width: 480px; width: 100%;
    background: rgba(19,24,37,0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid var(--border);
    display: flex;
    z-index: 100;
  }
  .tab-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 12px 0 calc(12px + env(safe-area-inset-bottom));
    color: var(--text-muted);
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.3px;
    cursor: pointer;
    transition: color 0.2s;
    user-select: none;
    position: relative;
  }
  .tab-item.active {
    color: var(--accent);
  }
  .tab-item.active::before {
    content: '';
    position: absolute;
    top: 0; left: 20%; right: 20%;
    height: 2px;
    background: var(--accent);
    border-radius: 0 0 2px 2px;
  }
  .tab-item svg {
    width: 22px; height: 22px;
  }

  /* Tab Content */
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }

  /* Snapshot Card */
  .snapshot {
    background: linear-gradient(135deg, #1E2A4A 0%, #162040 100%);
    border: 1px solid rgba(79,140,255,0.15);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
  }
  .snapshot::after {
    content: '';
    position: absolute;
    top: -40px; right: -40px;
    width: 120px; height: 120px;
    background: radial-gradient(circle, rgba(79,140,255,0.12) 0%, transparent 70%);
    pointer-events: none;
  }
  .snapshot-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-muted);
    margin-bottom: 16px;
    font-weight: 500;
  }
  .snapshot-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    gap: 16px;
  }
  .snapshot-metric { flex: 1; }
  .snapshot-metric .label {
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 6px;
  }
  .snapshot-metric .value {
    font-family: 'Playfair Display', serif;
    font-size: 32px;
    font-weight: 700;
    line-height: 1;
  }
  .snapshot-metric .unit {
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-muted);
    margin-left: 2px;
  }
  .divider-v {
    width: 1px;
    height: 48px;
    background: rgba(255,255,255,0.08);
    flex-shrink: 0;
  }

  /* Section Title */
  .section-title {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-muted);
    font-weight: 500;
    margin-bottom: 12px;
    padding-left: 4px;
  }

  /* Reg DPP Summary */
  .reg-summary {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 24px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .reg-summary .reg-label {
    font-size: 15px;
    font-weight: 700;
  }
  .reg-summary .reg-values {
    display: flex;
    gap: 20px;
    align-items: center;
  }
  .reg-stat { text-align: center; }
  .reg-stat .val {
    font-size: 20px;
    font-weight: 700;
  }
  .reg-stat .lbl {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    margin-top: 2px;
  }

  /* Bucket Cards */
  .buckets {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 28px;
  }
  .bucket-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 18px 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: all 0.2s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }
  .bucket-card:hover {
    border-color: rgba(255,255,255,0.12);
    transform: translateY(-1px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  }
  .bucket-indicator {
    width: 4px;
    height: 36px;
    border-radius: 4px;
    flex-shrink: 0;
  }
  .bucket-info { flex: 1; }
  .bucket-info .bucket-name {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
  }
  .bucket-info .bucket-range {
    font-size: 12px;
    color: var(--text-muted);
  }
  .bucket-stats {
    display: flex;
    gap: 16px;
    align-items: center;
  }
  .bucket-stat {
    text-align: center;
    min-width: 52px;
  }
  .bucket-val {
    font-size: 20px;
    font-weight: 700;
    font-family: 'Playfair Display', serif;
    line-height: 1.2;
  }
  .bucket-lbl {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    margin-top: 2px;
  }
  .pos-val {
    color: var(--accent) !important;
    font-size: 16px;
  }
  .cr-unit {
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    font-weight: 500;
    color: var(--text-muted);
    margin-left: 1px;
  }
  .bucket-bar {
    position: absolute;
    bottom: 0; left: 0;
    height: 2px;
    transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1);
  }

  /* Color variants */
  .bucket-card[data-bucket="1-30"] .bucket-indicator,
  .bucket-card[data-bucket="1-30"] .bucket-bar { background: var(--green); }
  .bucket-card[data-bucket="1-30"] .bucket-val { color: var(--green); }
  .bucket-card[data-bucket="31-60"] .bucket-indicator,
  .bucket-card[data-bucket="31-60"] .bucket-bar { background: var(--amber); }
  .bucket-card[data-bucket="31-60"] .bucket-val { color: var(--amber); }
  .bucket-card[data-bucket="61-90"] .bucket-indicator,
  .bucket-card[data-bucket="61-90"] .bucket-bar { background: var(--orange); }
  .bucket-card[data-bucket="61-90"] .bucket-val { color: var(--orange); }
  .bucket-card[data-bucket="npa"] .bucket-indicator,
  .bucket-card[data-bucket="npa"] .bucket-bar { background: var(--red); }
  .bucket-card[data-bucket="npa"] .bucket-val { color: var(--red); }

  /* Bar Chart */
  .bar-visual {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 28px;
  }
  .bar-visual .bv-title {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-muted);
    font-weight: 500;
    margin-bottom: 20px;
  }
  .bar-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 14px;
  }
  .bar-row:last-child { margin-bottom: 0; }
  .bar-label {
    width: 52px;
    font-size: 12px;
    color: var(--text-muted);
    text-align: right;
    flex-shrink: 0;
  }
  .bar-track {
    flex: 1;
    height: 28px;
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
    overflow: hidden;
  }
  .bar-fill {
    height: 100%;
    border-radius: 8px;
    display: flex;
    align-items: center;
    padding-left: 10px;
    font-size: 12px;
    font-weight: 600;
    color: rgba(0,0,0,0.7);
    transition: width 1s cubic-bezier(0.22, 1, 0.36, 1);
  }

  /* Disbursement Table */
  .disb-table {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    margin-bottom: 12px;
  }
  .dt-header {
    display: flex;
    padding: 14px 20px 10px;
    border-bottom: 1px solid var(--border);
  }
  .dt-cell {
    flex: 1;
    text-align: right;
  }
  .dt-label-cell {
    flex: 1.3;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 500;
  }
  .dt-head {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    font-weight: 500;
  }
  .dt-row {
    display: flex;
    padding: 16px 20px;
    align-items: center;
    border-bottom: 1px solid var(--border);
  }
  .dt-row:last-child {
    border-bottom: none;
  }
  .dt-val {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    font-weight: 700;
    text-align: right;
  }
  .dt-total {
    background: rgba(52,211,153,0.04);
  }
  .dt-total .dt-label-cell {
    color: var(--green);
    font-weight: 700;
  }
  .dt-total .dt-val {
    color: var(--green);
  }
  .dt-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  /* Disbursement */
  .disb-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .disb-row-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .disb-row-item .dri-label {
    font-size: 14px;
    font-weight: 500;
  }
  .disb-row-item .dri-label span {
    font-size: 12px;
    color: var(--text-muted);
    display: block;
    margin-top: 2px;
  }
  .disb-row-item .dri-val {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    font-weight: 700;
    color: var(--accent);
  }

  /* Month Picker Overlay */
  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 200;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease;
  }
  .overlay.open {
    opacity: 1;
    pointer-events: all;
  }
  .month-picker {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px 20px 0 0;
    max-width: 480px;
    width: 100%;
    padding: 24px 20px 36px;
    transform: translateY(100%);
    transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1);
  }
  .overlay.open .month-picker {
    transform: translateY(0);
  }
  .picker-handle {
    width: 36px;
    height: 4px;
    background: rgba(255,255,255,0.15);
    border-radius: 4px;
    margin: 0 auto 20px;
  }
  .picker-title {
    font-family: 'Playfair Display', serif;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 6px;
    text-align: center;
  }
  .picker-subtitle {
    font-size: 12px;
    color: var(--text-muted);
    text-align: center;
    margin-bottom: 20px;
  }
  .month-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }
  .year-selector {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 24px;
    margin-bottom: 20px;
  }
  .year-label {
    font-family: 'Playfair Display', serif;
    font-size: 22px;
    font-weight: 700;
    min-width: 70px;
    text-align: center;
    user-select: none;
  }
  .year-arrow {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    background: var(--surface-2);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--text-muted);
    user-select: none;
  }
  .year-arrow:hover {
    background: rgba(79,140,255,0.1);
    border-color: rgba(79,140,255,0.25);
    color: var(--accent);
  }
  .year-arrow:active {
    transform: scale(0.92);
  }
  .year-arrow svg {
    width: 18px;
    height: 18px;
  }
  .month-btn {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
  }
  .month-btn:hover {
    border-color: rgba(79,140,255,0.3);
    background: rgba(79,140,255,0.08);
  }
  .month-btn.selected {
    border-color: var(--accent);
    background: rgba(79,140,255,0.12);
    box-shadow: 0 0 20px rgba(79,140,255,0.1);
  }
  .month-btn .mb-month {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
  }
  .month-btn.selected .mb-month {
    color: var(--accent);
  }
  .month-btn .mb-date {
    font-size: 11px;
    color: var(--text-muted);
  }

  /* FY Button */
  .fy-btn-wrap {
    margin-top: 20px;
  }
  .fy-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 15px;
    font-weight: 600;
    color: var(--accent);
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
  }
  .fy-btn:hover {
    background: rgba(79,140,255,0.06);
    border-color: rgba(79,140,255,0.2);
  }
  .fy-btn:active {
    transform: scale(0.98);
  }
  .fy-btn svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }

  /* FY Sheet */
  .fy-sheet {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px 20px 0 0;
    max-width: 480px;
    width: 100%;
    padding: 24px 20px 36px;
    transform: translateY(100%);
    transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1);
    max-height: 80vh;
    overflow-y: auto;
  }
  .overlay.open .fy-sheet {
    transform: translateY(0);
  }
  .dt-current {
    background: rgba(79,140,255,0.05);
  }
  .dt-current .dt-label-cell {
    color: var(--accent);
    font-weight: 600;
  }

  /* Fade animation */
  .fade-enter {
    animation: fadeContentIn 0.3s ease forwards;
  }
  @keyframes fadeContentIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>

<div class="app">
  <div class="header">
    <div class="header-left">
      <h1>Portfolio</h1>
      <div class="subtitle">Design — Aman</div>
    </div>
    <div class="date-badge" id="dateBadge" onclick="openPicker()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      <span id="dateBadgeText">Jan 31, 25</span>
    </div>
  </div>

  <div class="tab-content active" id="collectionTab">
    <div id="collectionContent"></div>
  </div>

  <div class="tab-content" id="disbursementTab">
    <div id="disbursementContent"></div>
  </div>
</div>

<!-- Bottom Tab Bar -->
<div class="tab-bar">
  <div class="tab-item active" data-tab="collection" onclick="switchTab('collection')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
    Collection
  </div>
  <div class="tab-item" data-tab="disbursement" onclick="switchTab('disbursement')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
    Disbursement
  </div>
</div>

<!-- Month Picker Overlay -->
<div class="overlay" id="overlay" onclick="closePicker(event)">
  <div class="month-picker" onclick="event.stopPropagation()">
    <div class="picker-handle"></div>
    <div class="picker-title">Select Month</div>
    <div class="picker-subtitle">Choose a month-end date to view data</div>
    <div class="year-selector">
      <div class="year-arrow" id="yearLeft" onclick="changeYear(-1)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
      </div>
      <div class="year-label" id="yearLabel">2025</div>
      <div class="year-arrow" id="yearRight" onclick="changeYear(1)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
    </div>
    <div class="month-grid" id="monthGrid"></div>
  </div>
</div>

<!-- FY Breakdown Overlay -->
<div class="overlay" id="fyOverlay" onclick="closeFY(event)">
  <div class="fy-sheet" onclick="event.stopPropagation()">
    <div class="picker-handle"></div>
    <div class="picker-title" id="fyTitle">FY 2024-25</div>
    <div class="picker-subtitle">Monthly disbursement breakdown</div>
    <div id="fyTableContent"></div>
  </div>
</div>

<script>
const months = [
  { key:'jan', date:'Jan 31', short:'Jan' },
  { key:'feb', date:'Feb 28', short:'Feb' },
  { key:'mar', date:'Mar 31', short:'Mar' },
  { key:'apr', date:'Apr 30', short:'Apr' },
  { key:'may', date:'May 31', short:'May' },
  { key:'jun', date:'Jun 30', short:'Jun' },
  { key:'jul', date:'Jul 31', short:'Jul' },
  { key:'aug', date:'Aug 31', short:'Aug' },
  { key:'sep', date:'Sep 30', short:'Sep' },
  { key:'oct', date:'Oct 31', short:'Oct' },
  { key:'nov', date:'Nov 30', short:'Nov' },
  { key:'dec', date:'Dec 31', short:'Dec' },
];

function seededRandom(seed) {
  let x = Math.sin(seed) * 10000;
  return x - Math.floor(x);
}

function generateData(mi, year) {
  year = year || selectedYear;
  const s = mi + 42 + (year * 13);
  const r = (min, max, offset = 0) => Math.round(min + seededRandom(s * (min + max + offset + 7)) * (max - min));
  const rf = (min, max, offset = 0) => parseFloat((min + seededRandom(s * (min * 3 + max * 7 + offset + 13)) * (max - min)).toFixed(2));

  const b1 = r(3, 12, 1);
  const b2 = r(2, 10, 2);
  const b3 = r(5, 15, 3);
  const npa = r(12, 30, 4);
  const regAccounts = r(380, 500, 5);
  const totalAccounts = regAccounts + b1 + b2 + b3 + npa;

  const b1Pos = rf(0.08, 0.30, 1);
  const b2Pos = rf(0.06, 0.25, 2);
  const b3Pos = rf(0.15, 0.50, 3);
  const npaPos = rf(0.40, 1.20, 4);
  const regPos = rf(1.10, 1.80, 5);
  const totalPos = parseFloat((b1Pos + b2Pos + b3Pos + npaPos + regPos).toFixed(2));

  const disbCount = r(20, 80, 6);
  const disbAmount = rf(0.5, 3.5, 7);
  const avgTicket = rf(2, 8, 8);
  const approvalRate = r(60, 95, 9);

  return {
    totalAccounts, regAccounts, totalPos, regPos,
    buckets: [
      { accounts: b1, pos: b1Pos },
      { accounts: b2, pos: b2Pos },
      { accounts: b3, pos: b3Pos },
      { accounts: npa, pos: npaPos },
    ],
    disbursement: { count: disbCount, amount: disbAmount, avgTicket, approvalRate }
  };
}

let selectedMonth = 0;
let selectedYear = 2025;

// Build month grid
const monthGrid = document.getElementById('monthGrid');
months.forEach((m, i) => {
  const btn = document.createElement('div');
  btn.className = 'month-btn' + (i === 0 ? ' selected' : '');
  btn.innerHTML = `<div class="mb-month">${m.short}</div><div class="mb-date">${m.date}</div>`;
  btn.onclick = () => selectMonth(i);
  monthGrid.appendChild(btn);
});

function changeYear(delta) {
  selectedYear += delta;
  document.getElementById('yearLabel').textContent = selectedYear;
  updateBadge();
  renderAll();
}

function updateBadge() {
  const shortYear = String(selectedYear).slice(-2);
  document.getElementById('dateBadgeText').textContent = `${months[selectedMonth].date}, ${shortYear}`;
}

function selectMonth(i) {
  selectedMonth = i;
  document.querySelectorAll('.month-btn').forEach((b, idx) => b.classList.toggle('selected', idx === i));
  updateBadge();
  renderAll();
  setTimeout(() => document.getElementById('overlay').classList.remove('open'), 200);
}

function openPicker() { document.getElementById('overlay').classList.add('open'); }
function closePicker(e) {
  if (e && e.target !== document.getElementById('overlay')) return;
  document.getElementById('overlay').classList.remove('open');
}

function switchTab(tab) {
  document.querySelectorAll('.tab-item').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
  document.getElementById(tab + 'Tab').classList.add('active');
}

function renderAll() {
  const data = generateData(selectedMonth);
  renderCollection(data);
  renderDisbursement(data);
}

function renderCollection(data) {
  const maxB = Math.max(...data.buckets.map(b => b.accounts));
  const colors = ['var(--green)', 'var(--amber)', 'var(--orange)', 'var(--red)'];
  const names = ['Bucket 1', 'Bucket 2', 'Bucket 3', 'NPA'];
  const ranges = ['1 — 30 DPD', '31 — 60 DPD', '61 — 90 DPD', '90+ DPD'];
  const keys = ['1-30', '31-60', '61-90', 'npa'];
  const barLbls = ['1-30', '31-60', '61-90', 'NPA'];

  document.getElementById('collectionContent').innerHTML = `
    <div class="snapshot fade-enter">
      <div class="snapshot-label">Snapshot</div>
      <div class="snapshot-row">
        <div class="snapshot-metric">
          <div class="label">A/c Allocated</div>
          <div class="value">${data.totalAccounts}</div>
        </div>
        <div class="divider-v"></div>
        <div class="snapshot-metric">
          <div class="label">Portfolio Value</div>
          <div class="value">${data.totalPos}<span class="unit">Cr</span></div>
        </div>
      </div>
    </div>
    <div class="section-title">DPD Bucket Allocation</div>
    <div class="reg-summary fade-enter">
      <div class="reg-label">Reg DPD</div>
      <div class="reg-values">
        <div class="reg-stat">
          <div class="val">${data.regAccounts}</div>
          <div class="lbl">Accounts</div>
        </div>
        <div class="reg-stat">
          <div class="val" style="color:var(--accent)">${data.regPos}<span style="font-size:12px;color:var(--text-muted)"> Cr</span></div>
          <div class="lbl">POS</div>
        </div>
      </div>
    </div>
    <div class="buckets">
      ${data.buckets.map((b, i) => `
        <div class="bucket-card fade-enter" data-bucket="${keys[i]}" style="animation-delay:${0.1+i*0.05}s">
          <div class="bucket-indicator"></div>
          <div class="bucket-info">
            <div class="bucket-name">${names[i]}</div>
            <div class="bucket-range">${ranges[i]}</div>
          </div>
          <div class="bucket-stats">
            <div class="bucket-stat">
              <div class="bucket-val">${b.accounts}</div>
              <div class="bucket-lbl">Accounts</div>
            </div>
            <div class="bucket-stat">
              <div class="bucket-val pos-val">${b.pos}<span class="cr-unit">Cr</span></div>
              <div class="bucket-lbl">POS</div>
            </div>
          </div>
          <div class="bucket-bar" style="width:${(b.accounts/maxB*100).toFixed(0)}%"></div>
        </div>
      `).join('')}
    </div>
    <div class="bar-visual fade-enter" style="animation-delay:0.35s">
      <div class="bv-title">Accounts Distribution</div>
      ${data.buckets.map((b, i) => `
        <div class="bar-row">
          <div class="bar-label">${barLbls[i]}</div>
          <div class="bar-track">
            <div class="bar-fill" style="width:${(b.accounts/maxB*100).toFixed(0)}%;background:${colors[i]};">${b.accounts}</div>
          </div>
        </div>
      `).join('')}
    </div>`;
}

function getCumulative(monthIndex) {
  // Financial year: Apr(3) to Mar(2)
  // If month is Apr-Dec, FY started same year. If Jan-Mar, FY started previous year.
  const fyOrder = [3,4,5,6,7,8,9,10,11,0,1,2];
  const selectedFyPos = fyOrder.indexOf(monthIndex);
  const fyStartYear = monthIndex >= 3 ? selectedYear : selectedYear - 1;

  let totalCount = 0, totalAmount = 0;
  for (let i = 0; i <= selectedFyPos; i++) {
    const m = fyOrder[i];
    const yr = m >= 3 ? fyStartYear : fyStartYear + 1;
    const d = generateData(m, yr).disbursement;
    totalCount += d.count;
    totalAmount += d.amount;
  }
  return { count: totalCount, amount: parseFloat(totalAmount.toFixed(2)) };
}

function renderDisbursement(data) {
  const d = data.disbursement;
  const cum = getCumulative(selectedMonth);
  const mLabel = months[selectedMonth].short;

  document.getElementById('disbursementContent').innerHTML = `
    <div class="section-title fade-enter">Disbursement Summary</div>

    <div class="disb-table fade-enter">
      <div class="dt-header">
        <div class="dt-cell dt-label-cell"></div>
        <div class="dt-cell dt-head">A/c</div>
        <div class="dt-cell dt-head">Amt (Cr)</div>
      </div>
      <div class="dt-row">
        <div class="dt-cell dt-label-cell"><span class="dt-dot" style="background:var(--accent)"></span>${mLabel}</div>
        <div class="dt-cell dt-val">${d.count}</div>
        <div class="dt-cell dt-val">${d.amount}</div>
      </div>
      <div class="dt-row dt-total">
        <div class="dt-cell dt-label-cell"><span class="dt-dot" style="background:var(--green)"></span>Total</div>
        <div class="dt-cell dt-val">${cum.count}</div>
        <div class="dt-cell dt-val">${cum.amount}</div>
      </div>
    </div>

    <div class="fy-btn-wrap fade-enter">
      <div class="fy-btn" onclick="openFY()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        FY Breakdown
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;margin-left:auto;"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
    </div>`;
}

renderAll();

function openFY() {
  const fyOrder = [3,4,5,6,7,8,9,10,11,0,1,2];
  const fyStartYear = selectedMonth >= 3 ? selectedYear : selectedYear - 1;
  const fyEndYear = fyStartYear + 1;
  const selectedFyPos = fyOrder.indexOf(selectedMonth);

  document.getElementById('fyTitle').textContent = `FY ${fyStartYear}-${String(fyEndYear).slice(-2)}`;

  let rows = '';
  let cumCount = 0, cumAmount = 0;

  for (let i = 0; i <= selectedFyPos; i++) {
    const m = fyOrder[i];
    const yr = m >= 3 ? fyStartYear : fyEndYear;
    const d = generateData(m, yr).disbursement;
    cumCount += d.count;
    cumAmount += d.amount;
    const isCurrentMonth = (i === selectedFyPos);
    rows += `
      <div class="dt-row ${isCurrentMonth ? 'dt-current' : ''}">
        <div class="dt-cell dt-label-cell">${months[m].short} ${String(yr).slice(-2)}</div>
        <div class="dt-cell dt-val">${d.count}</div>
        <div class="dt-cell dt-val">${d.amount}</div>
      </div>`;
  }

  rows += `
    <div class="dt-row dt-total">
      <div class="dt-cell dt-label-cell"><span class="dt-dot" style="background:var(--green)"></span>Total</div>
      <div class="dt-cell dt-val">${cumCount}</div>
      <div class="dt-cell dt-val">${parseFloat(cumAmount.toFixed(2))}</div>
    </div>`;

  document.getElementById('fyTableContent').innerHTML = `
    <div class="disb-table">
      <div class="dt-header">
        <div class="dt-cell dt-label-cell">Month</div>
        <div class="dt-cell dt-head">A/c</div>
        <div class="dt-cell dt-head">Amt (Cr)</div>
      </div>
      ${rows}
    </div>`;

  document.getElementById('fyOverlay').classList.add('open');
}

function closeFY(e) {
  if (e && e.target !== document.getElementById('fyOverlay')) return;
  document.getElementById('fyOverlay').classList.remove('open');
}
</script>
</body>
</html>
